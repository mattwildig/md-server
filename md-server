#!/usr/bin/env ruby

require 'sinatra'
require 'tilt'

enable :run

get "/" do
  files(".")
end

get %r{^/((.*)$)} do
  name = params[:captures][0]
  if Tilt[name]
    Tilt.new(name).render
  elsif File.directory?(name)
    files(name)
  else
    [404, "Nothing to render for \"#{name}\""]
  end
end

helpers do
  def files(dir)
    @files = Dir[File.join(dir, "*")].select{|f| Tilt[f] || File.directory?(f)}
    if @files == []
      "No template files found."
    else
      erb :index
    end
  end
end

__END__

@@index

<ul>
<% @files.each do |f| %>
  <%="<li><a href='#{f}'>#{File.basename f}</a></li>"%>
<%end%>
</ul>
  