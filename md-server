#!/usr/bin/env ruby

require 'rack'
require 'erb'
require 'tilt'

@template = DATA.read

def files(dir)
  dir_contents = Dir[File.join(dir, "*")].select{|f| Tilt[f] || File.directory?(f)}
  if dir_contents == []
    [200, {"Content-Type" => "text/html"}, ["No template files found."]]
  else
    result = ERB.new(@template).result binding
    return [200, {"Content-Type" => "text/html"}, [result]]
  end
end

app = lambda do |env|
  path = env['PATH_INFO'][1..-1]
  
  begin
    return [200, {"Content-Type" => "text/html"}, [Tilt.new(path).render]]
  rescue Errno::ENOENT
    return [404, {"Content-Type" => "text/html"}, ["No such file \"#{path}\""]]
  end if Tilt[path]
  
  return files(".") if path.empty?
  return files(path) if File.directory? path
  [404, {"Content-Type" => "text/html"}, ["Nothing to render for \"#{path}\""]]
end

Rack::Server.start :app => app, :Port => 9292

__END__

<ul>
<% dir_contents.each do |f| %>
  <%="<li><a href='#{f}'>#{File.basename f}</a></li>"%>
<%end%>
</ul>
  